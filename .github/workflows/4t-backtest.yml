name: Backtest 4t (Pinned SHA)

on:
  workflow_dispatch:
    inputs:
      train_start:
        description: "Train start"
        required: true
        default: "2025-01-01"
      train_end:
        description: "Train end"
        required: true
        default: "2025-04-30"
      test_start:
        description: "Test start"
        required: true
        default: "2025-05-01"
      test_end:
        description: "Test end"
        required: true
        default: "2025-06-30"
      H:
        description: "Horizon"
        required: true
        default: "5"
      fee_bps:
        description: "Fee (bps)"
        required: true
        default: "1.0"
      cov_low:
        description: "Coverage low"
        required: true
        default: "0.20"
      cov_high:
        description: "Coverage high"
        required: true
        default: "0.40"

permissions:
  contents: read

jobs:
  backtest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (pinned)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Set up Python (pinned)
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'   # 3.13도 가능하지만 sklearn 안정성상 3.11 권장

      - name: Cache pip (pinned)
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809  # v4.2.4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Prepare repo layout (unzip packs)
        run: |
          set -e
          mkdir -p data _out_4t
          shopt -s nullglob
          for z in *.zip; do
            echo "Unzipping $z"
            unzip -o "$z" -d .
          done
          # CSV를 data/로 이동(여러 위치 대비)
          cands=(
            "./ETHUSDT_1min_2020_2025.csv"
            "./data/ETHUSDT_1min_2020_2025.csv"
            "./trend4p/ETHUSDT_1min_2020_2025.csv"
          )
          found=""
          for p in "${cands[@]}"; do
            if [ -f "$p" ]; then found="$p"; break; fi
          done
          if [ -z "$found" ]; then
            # 루트/서브폴더 전체 탐색(최대 1개만 기대)
            found=$(git ls-files -- ':/*ETHUSDT_1min_2020_2025.csv' | head -n 1 || true)
          fi
          if [ -n "$found" ]; then
            echo "CSV found: $found"
            mv -f "$found" data/ETHUSDT_1min_2020_2025.csv
          fi
          test -f data/ETHUSDT_1min_2020_2025.csv || (echo "CSV not found"; exit 1)

      - name: Install dependencies
        run: |
          set -e
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install --upgrade pip
            pip install pandas numpy scikit-learn==1.5.2 scipy ta pyarrow
          fi

      - name: Sanity check (schema & time col)
        run: |
          python - <<'PY'
          import pandas as pd, sys
          df = pd.read_csv('data/ETHUSDT_1min_2020_2025.csv', nrows=5)
          cols = set(df.columns.str.lower())
          need = {'open_time','open','high','low','close','volume'}
          miss = need - cols
          if miss:
            print("Missing columns:", miss); sys.exit(1)
          print("OK header:", list(df.columns))
          PY

      - name: Run 4t backtest
        run: |
          set -e
          # 실행 엔트리포인트: run_4t.py (repo 루트에 있다고 가정)
          python ./run_4t.py \
            --data ./data/ETHUSDT_1min_2020_2025.csv \
            --train_start '${{ inputs.train_start }}' \
            --train_end   '${{ inputs.train_end }}' \
            --test_start  '${{ inputs.test_start }}' \
            --test_end    '${{ inputs.test_end }}' \
            --H '${{ inputs.H }}' \
            --fee_bps '${{ inputs.fee_bps }}' \
            --cov_low '${{ inputs.cov_low }}' \
            --cov_high '${{ inputs.cov_high }}' \
            --out_dir ./_out_4t
          echo "==== RESULT PREVIEW ===="
          ls -al _out_4t || true
          echo "========================"

      - name: Upload results (pinned)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: backtest_4t_outputs
          path: |
            _out_4t/**
            **/runlog.txt
          if-no-files-found: warn
          retention-days: 14
