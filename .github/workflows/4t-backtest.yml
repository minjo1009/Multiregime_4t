# .github/workflows/4u-backtest.yml
name: 4u-backtest

on:
  workflow_dispatch:
    inputs:
      code_zip:
        description: '코드 ZIP 파일명 (레포 루트)'
        required: true
        default: 'trend4u.zip'
      data_zip:
        description: '데이터 ZIP 파일명 (레포 루트)'
        required: true
        default: 'ETHUSDT_1min_2020_2025.zip'
      data_csv:
        description: '데이터 CSV 파일명 (ZIP 풀면 나오는 파일명)'
        required: true
        default: 'ETHUSDT_1min_2020_2025.csv'
      train_start:
        required: true
        default: '2024-01-01'
      train_end:
        required: true
        default: '2025-04-30'
      test_start:
        required: true
        default: '2025-05-01'
      test_end:
        required: true
        default: '2025-07-31'
      H:
        required: true
        default: '5'
      fee_bps:
        required: true
        default: '1.5'
      cov_low:
        required: true
        default: '0.2'
      cov_high:
        required: true
        default: '0.4'

permissions:
  contents: read

concurrency:
  group: backtest-${{ github.ref }}
  cancel-in-progress: false

env:
  TZ: Asia/Seoul
  OUT_DIR: out

jobs:
  backtest:
    runs-on: ubuntu-latest
    steps:
      # 필수 액션은 '풀 길이 커밋 SHA'로 고정 (레포 정책 충족)
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
      - name: Setup Python 3.11
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: trend4u/requirements.txt
      - name: Verify ZIPs exist at repo root
        run: |
          set -euo pipefail
          echo "Repo: $GITHUB_REPOSITORY"
          echo "SHA : $GITHUB_SHA"
          echo "TZ  : $TZ"
          ls -al
          if [[ ! -f "${{ inputs.code_zip }}" ]]; then
            echo "::error::코드 ZIP을 찾을 수 없습니다: ${{ inputs.code_zip }}"; exit 1; fi
          if [[ ! -f "${{ inputs.data_zip }}" ]]; then
            echo "::error::데이터 ZIP을 찾을 수 없습니다: ${{ inputs.data_zip }}"; exit 1; fi
      - name: Unpack code & data
        run: |
          set -euo pipefail
          mkdir -p logs "${OUT_DIR}"
          unzip -o "${{ inputs.code_zip }}" -d "$GITHUB_WORKSPACE"
          unzip -o "${{ inputs.data_zip }}" -d "$GITHUB_WORKSPACE"
          # trend4u 패키지 내부 구조에 맞춰 data 폴더 생성 후 CSV 이동
          mkdir -p trend4u/data
          if [[ -f "${{ inputs.data_csv }}" ]]; then
            mv -f "${{ inputs.data_csv }}" trend4u/data/
          else
            # 혹시 CSV 이름이 다르면 루트의 첫 CSV를 사용
            CSV=$(ls -1 *.csv 2>/dev/null | head -n1 || true)
            if [[ -z "${CSV}" ]]; then
              echo "::error::루트에서 CSV를 찾지 못했습니다. inputs.data_csv 를 확인하세요."; exit 1
            fi
            mv -f "${CSV}" trend4u/data/
          fi
          echo "== trend4u 디렉토리 구조 =="
          (cd trend4u && find . -maxdepth 2 -type f | sort | sed -n '1,200p')
      - name: Install deps
        run: |
          set -euo pipefail
          python -V | tee -a logs/versions.txt
          pip install --upgrade pip
          pip install -r trend4u/requirements.txt
      - name: Run backtest
        run: |
          set -euo pipefail
          cd trend4u
          # run_4u.py는 trend4u/ 를 CWD로 실행해야 내부 import가 깨지지 않음
          python -u run_4u.py \
            --data "data/${{ inputs.data_csv }}" \
            --train_start "${{ inputs.train_start }}" \
            --train_end   "${{ inputs.train_end }}" \
            --test_start  "${{ inputs.test_start }}" \
            --test_end    "${{ inputs.test_end }}" \
            --H "${{ inputs.H }}" \
            --fee_bps "${{ inputs.fee_bps }}" \
            --cov_low "${{ inputs.cov_low }}" \
            --cov_high "${{ inputs.cov_high }}" \
            --out_dir "../${OUT_DIR}"
          echo "== 결과 파일 목록 =="
          find "../${OUT_DIR}" -type f -maxdepth 2 -print | sed -n '1,200p'
      - name: Upload results (artifact)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: backtest-${{ github.run_id }}
          path: out/**
          if-no-files-found: error
          retention-days: 7
