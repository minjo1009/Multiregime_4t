name: backtest

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  run-backtest:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      CODE_ZIP: trend4u.zip
      DATA_ZIP: ETH_1min.zip

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # pinned SHA

      - name: Setup Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # pinned SHA
        with:
          python-version: "3.11"

      - name: Prepare directories
        run: mkdir -p logs out code data

      - name: Unpack code and data
        run: |
          unzip -o "$CODE_ZIP" -d code
          unzip -o "$DATA_ZIP" -d data

      - name: Install dependencies
        run: |
          cd code/trend4u
          if [[ -f requirements.txt ]]; then
            pip install -r requirements.txt
          elif [[ -f pyproject.toml ]]; then
            pip install .
          else
            pip install numpy pandas matplotlib ta python-dateutil pytz
          fi

      - name: Run backtest
        working-directory: code/trend4u
        run: |
          echo "Python version:" > ../../logs/versions.txt
          python -V >> ../../logs/versions.txt
          python run_4u.py --data ../../data/ETHUSDT_1min.csv --out ../../out

      - name: Upload artifacts
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # pinned SHA
        with:
          name: backtest-results
          path: |
            out/**
            logs/**
