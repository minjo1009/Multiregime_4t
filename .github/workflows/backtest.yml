name: Backtest

on:
  workflow_dispatch:
    inputs:
      TRADE_ZIP:
        description: "Code zip at repo root (e.g., trade_v1.0.7.zip)"
        required: true
      DATA_ZIP:
        description: "Data zip at repo root (e.g., ETHUSDT_1min_2020_2025.zip)"
        required: true
      CSV_GLOB:
        description: "CSV pattern inside DATA_DIR (e.g., *ETHUSDT*1min*2020*2025*.csv)"
        required: true
      OUT_DIR:
        description: "Output directory (relative to workspace)"
        default: "_out_4u/run"
        required: true

jobs:
  run-backtest:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      REPO_DIR: repo
      RUN_DIR: tmp/trade
      DATA_DIR: tmp/data
      OUT_DIR: ${{ inputs.OUT_DIR }}
      PYTHONUTF8: "1"
      OMP_NUM_THREADS: "2"
      OPENBLAS_NUM_THREADS: "2"
      MKL_NUM_THREADS: "2"
      NUMEXPR_NUM_THREADS: "2"

    steps:
      # ---------- 입력 검증(대문자 키) ----------
      - name: Validate dispatch inputs
        shell: bash
        run: |
          set -euo pipefail
          bad=0
          for k in TRADE_ZIP DATA_ZIP CSV_GLOB OUT_DIR; do
            v="${{ inputs.TRADE_ZIP }}"
            : # noop (GH 제한 회피용)
          done
          [ -n "${{ inputs.TRADE_ZIP }}" ] || { echo "❌ TRADE_ZIP empty"; bad=1; }
          [ -n "${{ inputs.DATA_ZIP }}" ]  || { echo "❌ DATA_ZIP empty"; bad=1; }
          [ -n "${{ inputs.CSV_GLOB }}" ]  || { echo "❌ CSV_GLOB empty"; bad=1; }
          [ -n "${{ inputs.OUT_DIR }}" ]   || { echo "❌ OUT_DIR empty"; bad=1; }
          [ $bad -eq 0 ] || exit 1

      # ---------- 자체 체크아웃(액션 불필요) ----------
      - name: Self-checkout repository (no actions/checkout)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p "${REPO_DIR}"
          cd "${REPO_DIR}"
          git init -q
          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git -c protocol.version=2 fetch --no-tags --depth=1 origin "${GITHUB_SHA}"
          git checkout -q FETCH_HEAD
          ls -al

      # ---------- 작업 폴더 준비 ----------
      - name: Prepare run/data/out directories
        shell: bash
        run: |
          set -euo pipefail
          rm -rf "${RUN_DIR}" "${DATA_DIR}" "${OUT_DIR}"
          mkdir -p "${RUN_DIR}" "${DATA_DIR}" "${OUT_DIR}"

      # ---------- 코드/데이터 ZIP 전개 ----------
      - name: Inflate code & data
        shell: bash
        run: |
          set -euo pipefail
          CODE_ZIP="${{ inputs.TRADE_ZIP }}"
          DATA_ZIP="${{ inputs.DATA_ZIP }}"
          test -f "${REPO_DIR}/${CODE_ZIP}" || { echo "❌ Code zip not found: ${REPO_DIR}/${CODE_ZIP}"; exit 1; }
          test -f "${REPO_DIR}/${DATA_ZIP}" || { echo "❌ Data zip not found: ${REPO_DIR}/${DATA_ZIP}"; exit 1; }
          unzip -q "${REPO_DIR}/${CODE_ZIP}" -d "${RUN_DIR}"
          unzip -q "${REPO_DIR}/${DATA_ZIP}" -d "${DATA_DIR}"
          echo "✅ Unzipped."
          echo "RUN_DIR tree (top):"; ls -al "${RUN_DIR}" | head -n 50
          echo "DATA_DIR csv candidates:"; ls -1 "${DATA_DIR}"/*.csv 2>/dev/null | head -n 5 || true

      # ---------- Preflight CSV (환경변수 export + 영속화) ----------
      - name: Preflight CSV
        shell: bash
        env:
          CSV_GLOB_IN: ${{ inputs.CSV_GLOB }}
        run: |
          set -euo pipefail
          CSV_PATH="$(ls ${DATA_DIR}/${CSV_GLOB_IN} 2>/dev/null | head -n1 || true)"
          [ -n "$CSV_PATH" ] || CSV_PATH="$(ls ${DATA_DIR}/*.csv 2>/dev/null | head -n1 || true)"
          [ -n "$CSV_PATH" ] || { echo "❌ No CSV found under ${DATA_DIR}"; exit 1; }
          echo "Using CSV_PATH=${CSV_PATH}"
          export CSV_PATH

          python - <<'PY'
import os, sys
import pandas as pd
p=os.environ.get('CSV_PATH')
if not p: print("❌ CSV_PATH missing"); sys.exit(1)
df=pd.read_csv(p, nrows=2)
need={'open_time','open','high','low','close','volume'}
miss=need - set(df.columns)
if miss:
    print("❌ Missing base columns:", sorted(miss)); sys.exit(1)
print("✅ Columns OK:", sorted(df.columns))
PY

          echo "CSV_PATH=${CSV_PATH}" >> "$GITHUB_ENV"

      # ---------- 파이썬 준비(요구사항 있으면 설치, 없으면 스킵) ----------
      - name: Install Python deps (optional)
        shell: bash
        working-directory: ${{ env.RUN_DIR }}
        run: |
          set -euo pipefail
          python3 -V
          python3 -m pip -q install -U pip
          if [ -f requirements.txt ]; then
            echo "Found requirements.txt -> installing"
            python3 -m pip install -r requirements.txt
          else
            echo "No requirements.txt -> installing minimum runtime"
            python3 -m pip install -q pyyaml pandas numpy scikit-learn
          fi
          python3 - <<'PY'
import sklearn, sys
print("sklearn", sklearn.__version__, "| py", sys.version)
from sklearn.calibration import CalibratedClassifierCV as C
import inspect
params = set(inspect.signature(C).parameters)
print("CalibratedClassifierCV param set:", sorted(params)[:5], "...(len=%d)"%len(params))
PY

      # ---------- 실행 전 파일 구조 확인 ----------
      - name: Sanity check run files
        shell: bash
        run: |
          set -euo pipefail
          ls -al "${RUN_DIR}" | sed -n '1,120p'
          test -f "${RUN_DIR}/run_4u.py" || { echo "❌ run_4u.py missing in ${RUN_DIR}"; exit 1; }

      # ---------- 백테스트 실행 ----------
      - name: Run backtest
        shell: bash
        working-directory: ${{ env.RUN_DIR }}
        run: |
          set -euo pipefail
          echo "CSV_PATH=${CSV_PATH}"
          python3 run_4u.py --data_path "${CSV_PATH}" --out_dir "${GITHUB_WORKSPACE}/${OUT_DIR}"
          echo "---- gating debug head ----"
          if [ -f "${GITHUB_WORKSPACE}/${OUT_DIR}/gating_debug.json" ]; then
            head -n 60 "${GITHUB_WORKSPACE}/${OUT_DIR}/gating_debug.json" || true
          else
            echo "{}" > "${GITHUB_WORKSPACE}/${OUT_DIR}/gating_debug.json"
          fi
          ls -al "${GITHUB_WORKSPACE}/${OUT_DIR}"

      # ---------- 아티팩트 업로드(핀 SHA) ----------
      - name: Upload artifacts (pinned)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: backtest-output
          path: |
            ${{ env.OUT_DIR }}/summary.json
            ${{ env.OUT_DIR }}/gating_debug.json
            ${{ env.OUT_DIR }}/preds_test.csv
            ${{ env.OUT_DIR }}/trades.csv
            ${{ env.OUT_DIR }}/charts/
          if-no-files-found: warn
          retention-days: 30