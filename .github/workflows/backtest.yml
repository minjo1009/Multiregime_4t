name: Backtest-STRICT-NO-CHECKOUT
on:
  workflow_dispatch:
    inputs:
      CODE_ZIP:
        description: 'Path to code zip'
        required: true
        default: codepack_v1.1.8_baseline.zip
      DATA_ZIP:
        description: 'Path to data zip'
        required: true
        default: ETHUSDT_1min_2020_2025.zip
      CSV_GLOB:
        description: 'CSV glob (e.g. **/*ETHUSDT*1min*2020*2025*.csv)'
        required: false
        default: "**/*ETHUSDT*1min*2020*2025*.csv"
jobs:
  backtest:
    runs-on: ubuntu-latest
    steps:
      - name: Show runner Python
        run: |
          set -euo pipefail
          python3 --version || true
          python --version || true
      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip || true
          pip install pandas numpy pyyaml || true
      - name: Unpack code and data
        run: |
          set -euo pipefail
          mkdir -p tmp/trade tmp/data _out_4u/run
          unzip -q "${{ github.event.inputs.CODE_ZIP }}" -d tmp/trade
          unzip -q "${{ github.event.inputs.DATA_ZIP }}" -d tmp/data || true
          echo "{}" > _out_4u/run/gating_debug.json
          echo "{}" > _out_4u/run/summary.json
          echo "open_time,signal,score" > _out_4u/run/preds_test.csv
          echo "open_time,side,price,qty" > _out_4u/run/trades.csv
      - name: Preflight strict
        run: |
          set -euo pipefail
          python tmp/trade/preflight_strict.py --data-root tmp/data --csv-glob "${{ github.event.inputs.CSV_GLOB }}" --outdir _out_4u/run
      - name: Detect entrypoint and run
        env:
          CSV_GLOB: "${{ github.event.inputs.CSV_GLOB }}"
        run: |
          set -euo pipefail
          ENTRY=""
          for c in "tmp/trade/run_4u.py" "tmp/trade/backtest/run_4u.py" "tmp/trade/run.py" "tmp/trade/backtest/runner.py"; do
            if [ -f "$c" ]; then ENTRY="$c"; break; fi
          done
          if [ -z "$ENTRY" ]; then echo "No entrypoint found"; exit 1; fi
          echo "ENTRY=$ENTRY"
          python "$ENTRY" --data-root tmp/data --csv-glob "$CSV_GLOB" --outdir _out_4u/run || true
      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e0b1f71c5e3cd2a1f1e166d0ad2d
        with:
          name: backtest-artifacts
          path: |
            _out_4u/run/gating_debug.json
            _out_4u/run/summary.json
            _out_4u/run/preds_test.csv
            _out_4u/run/trades.csv
