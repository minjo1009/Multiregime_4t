name: backtest

on:
  workflow_dispatch:
    inputs:
      trade_zip_path:
        description: "Path to trade code zip (in repo)"
        required: true
        default: "trade_v1.0.zip"
      data_zip_path:
        description: "Path to 1m data zip (in repo)"
        required: true
        default: "ETHUSDT_1min_2020_2025.zip"
      out_dir:
        description: "Output dir"
        required: false
        default: "_out_4u/run"
  push:
    branches: [ main ]
    paths:
      - "**/*.zip"
      - ".github/workflows/backtest.yml"

permissions:
  contents: read

concurrency:
  group: backtest-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run-backtest:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      TRADE_ZIP: ${{ github.event.inputs.trade_zip_path || 'trade_v1.0.zip' }}
      DATA_ZIP:  ${{ github.event.inputs.data_zip_path  || 'ETHUSDT_1min_2020_2025.zip' }}
      OUT_DIR:   ${{ github.event.inputs.out_dir        || '_out_4u/run' }}

    steps:
      - name: Checkout (pinned SHA)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Ensure unzip
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip

      - name: Show repo listing
        run: ls -alh

      # --- Unzip trade code & locate run_4u.py ---
      - name: Unzip trade pack
        shell: bash
        run: |
          set -euo pipefail
          test -f "$TRADE_ZIP" || { echo "❌ Trade zip not found: $TRADE_ZIP"; exit 1; }
          mkdir -p tmp/trade
          unzip -q -o "$TRADE_ZIP" -d tmp/trade

          RUN_FILE="$(find tmp/trade -type f -name 'run_4u.py' | head -n1 || true)"
          if [ -z "$RUN_FILE" ]; then
            echo "❌ run_4u.py not found inside $TRADE_ZIP"; exit 1
          fi
          RUN_DIR="$(dirname "$RUN_FILE")"
          echo "RUN_DIR=$RUN_DIR" >> "$GITHUB_ENV"

          REQS_FILE="$(find "$RUN_DIR" -maxdepth 1 -type f -name 'requirements.txt' | head -n1 || true)"
          if [ -n "$REQS_FILE" ]; then
            echo "REQS_FILE=$REQS_FILE" >> "$GITHUB_ENV"
          fi

          echo "ℹ️ RUN_DIR=$RUN_DIR"
          [ -n "${REQS_FILE:-}" ] && echo "ℹ️ requirements: $REQS_FILE"

      # --- Unzip data & locate CSV (ETH 1m 우선) ---
      - name: Unzip data pack
        shell: bash
        run: |
          set -euo pipefail
          test -f "$DATA_ZIP" || { echo "❌ Data zip not found: $DATA_ZIP"; exit 1; }
          mkdir -p tmp/data
          unzip -q -o "$DATA_ZIP" -d tmp/data

          CSV_PATH="$(find tmp/data -type f \( -iname '*ETH*1min*.csv' -o -iname '*.csv' \) | head -n1 || true)"
          if [ -z "$CSV_PATH" ]; then
            echo "❌ No CSV found in $DATA_ZIP"; exit 1
          fi
          echo "CSV_PATH=$CSV_PATH" >> "$GITHUB_ENV"
          echo "ℹ️ CSV_PATH=$CSV_PATH"
          wc -l "$CSV_PATH" || true
          head -n 3 "$CSV_PATH" || true

      - name: Set up Python (pinned SHA)
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -n "${REQS_FILE:-}" ] && [ -f "$REQS_FILE" ]; then
            pip install -r "$REQS_FILE"
          else
            pip install numpy pandas scikit-learn matplotlib pyyaml
          fi
          python -c "import sys,platform; print('Python',sys.version); print('Platform',platform.platform())"
          pip list | sed -n '1,120p'

      # --- Preflight validation: 컬럼/타임스탬프/행수 ---
      - name: Preflight checks (CSV format & viability)
        shell: bash
        run: |
          set -euo pipefail
          python - << 'PY'
import sys, pandas as pd
csv = r"${CSV_PATH}"
need = {'open_time','open','high','low','close','volume','number_of_trades','taker_buy_base_asset_volume'}
try:
    df = pd.read_csv(csv, nrows=2)
except Exception as e:
    print(f"❌ CSV read failed: {e}"); sys.exit(1)
cols = set(df.columns)
missing = need - cols
if missing:
    # 알려진 대체 컬럼 힌트
    hints = {'taker_buy_quote_asset_volume','taker_buy_volume'}
    overlap = hints & cols
    if 'taker_buy_quote_asset_volume' in overlap:
        print("❌ Need 'taker_buy_base_asset_volume' but found 'taker_buy_quote_asset_volume'. "
              "무료 바이낸스 1분봉 표준 컬럼을 맞추거나, 코드에서 맵핑 필요.")
    else:
        print(f"❌ Missing required columns: {missing}")
    sys.exit(1)
print("✅ Columns OK:", sorted(list(cols)))
PY

      - name: Run backtest
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$OUT_DIR"
          echo "▶ python $RUN_DIR/run_4u.py --data_path \"$CSV_PATH\" --out_dir \"$OUT_DIR\""
          python "$RUN_DIR/run_4u.py" --data_path "$CSV_PATH" --out_dir "$OUT_DIR"

      - name: Verify outputs exist
        shell: bash
        run: |
          test -f "$OUT_DIR/summary.json" || { echo "❌ summary.json not found in $OUT_DIR"; exit 1; }
          echo "==== SUMMARY (first 2000 chars) ===="
          head -c 2000 "$OUT_DIR/summary.json" || true
          echo ""

      - name: Upload artifacts (pinned SHA)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: backtest-output
          path: |
            ${{ env.OUT_DIR }}/summary.json
            ${{ env.OUT_DIR }}/charts/
          if-no-files-found: warn
          retention-days: 30