name: backtest (strict v1.1.7, robust fetch)
on:
  workflow_dispatch:
    inputs:
      CODE_ZIP:
        description: Code zip (path, URL, or release asset name)
        required: true
        default: trade_v1.1.7.zip
      DATA_ZIP:
        description: Data zip (path, URL, or release asset name)
        required: true
        default: ETHUSDT_1min_2020_2025.zip
      CSV_GLOB:
        description: CSV file name (exact or glob)
        required: true
        default: ETHUSDT_1min_2020_2025.csv

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      RUN_DIR: tmp/trade
      DATA_DIR: tmp/data
      OUT_DIR: _out_4u/run
      PYVER: '3.11'

    steps:
      - name: Validate pinned SHAs
        shell: bash
        run: |
          set -euo pipefail
          curl -sSfL -I https://api.github.com/repos/actions/checkout/tarball/08c6903cd8c0fde910a37f88322edcfb5dd907a8 >/dev/null
          curl -sSfL -I https://api.github.com/repos/actions/setup-python/tarball/a26af69be951a213d495a4c3e4e4022e16d87065 >/dev/null
          curl -sSfL -I https://api.github.com/repos/actions/upload-artifact/tarball/ea165f8d65b6e75b540449e92b4886f43607fa02 >/dev/null
          echo "Pinned SHAs OK"

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      # ---- Robust fetch for CODE_ZIP ----
      - name: Fetch code zip (path/URL/release)
        shell: bash
        env:
          INPUT_CODE_ZIP: ${{ github.event.inputs.CODE_ZIP }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p tmp/fetch
          TARGET="tmp/fetch/code.zip"

          fetch_ok=0
          if [[ "${INPUT_CODE_ZIP}" =~ ^https?:// ]]; then
            echo "[fetch] downloading from URL: ${INPUT_CODE_ZIP}"
            curl -sSfL -o "${TARGET}" "${INPUT_CODE_ZIP}" && fetch_ok=1 || fetch_ok=0
          elif [[ -f "${INPUT_CODE_ZIP}" ]]; then
            echo "[fetch] using workspace relative file: ${INPUT_CODE_ZIP}"
            cp -f "${INPUT_CODE_ZIP}" "${TARGET}" && fetch_ok=1 || fetch_ok=0
          elif [[ -f "${GITHUB_WORKSPACE}/${INPUT_CODE_ZIP}" ]]; then
            echo "[fetch] using workspace file: ${GITHUB_WORKSPACE}/${INPUT_CODE_ZIP}"
            cp -f "${GITHUB_WORKSPACE}/${INPUT_CODE_ZIP}" "${TARGET}" && fetch_ok=1 || fetch_ok=0
          fi

          if [[ "${fetch_ok}" -eq 0 ]]; then
            if command -v gh >/dev/null 2>&1; then
              echo "[fetch] trying release asset: ${INPUT_CODE_ZIP}"
              gh release download -R "${GITHUB_REPOSITORY}" --pattern "${INPUT_CODE_ZIP}" --clobber --dir tmp/fetch
              mv "tmp/fetch/${INPUT_CODE_ZIP}" "${TARGET}"
              fetch_ok=1
            else
              echo "::error::gh CLI not available and file not found. Provide path or URL for CODE_ZIP."
              exit 66
            fi
          fi

          test -s "${TARGET}" || { echo "::error::code zip not fetched"; exit 66; }
          echo "CODE_ZIP_ABS=${GITHUB_WORKSPACE}/${TARGET}" >> "$GITHUB_ENV"
          echo "[fetch] code zip at: ${GITHUB_WORKSPACE}/${TARGET}"

      # ---- Robust fetch for DATA_ZIP ----
      - name: Fetch data zip (path/URL/release)
        shell: bash
        env:
          INPUT_DATA_ZIP: ${{ github.event.inputs.DATA_ZIP }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p tmp/fetch
          TARGET="tmp/fetch/data.zip"

          fetch_ok=0
          if [[ "${INPUT_DATA_ZIP}" =~ ^https?:// ]]; then
            echo "[fetch] downloading from URL: ${INPUT_DATA_ZIP}"
            curl -sSfL -o "${TARGET}" "${INPUT_DATA_ZIP}" && fetch_ok=1 || fetch_ok=0
          elif [[ -f "${INPUT_DATA_ZIP}" ]]; then
            echo "[fetch] using workspace relative file: ${INPUT_DATA_ZIP}"
            cp -f "${INPUT_DATA_ZIP}" "${TARGET}" && fetch_ok=1 || fetch_ok=0
          elif [[ -f "${GITHUB_WORKSPACE}/${INPUT_DATA_ZIP}" ]]; then
            echo "[fetch] using workspace file: ${GITHUB_WORKSPACE}/${INPUT_DATA_ZIP}"
            cp -f "${GITHUB_WORKSPACE}/${INPUT_DATA_ZIP}" "${TARGET}" && fetch_ok=1 || fetch_ok=0
          fi

          if [[ "${fetch_ok}" -eq 0 ]]; then
            if command -v gh >/dev/null 2>&1; then
              echo "[fetch] trying release asset: ${INPUT_DATA_ZIP}"
              gh release download -R "${GITHUB_REPOSITORY}" --pattern "${INPUT_DATA_ZIP}" --clobber --dir tmp/fetch
              mv "tmp/fetch/${INPUT_DATA_ZIP}" "${TARGET}"
              fetch_ok=1
            else
              echo "::error::gh CLI not available and file not found. Provide path or URL for DATA_ZIP."
              exit 66
            fi
          fi

          test -s "${TARGET}" || { echo "::error::data zip not fetched"; exit 66; }
          echo "DATA_ZIP_ABS=${GITHUB_WORKSPACE}/${TARGET}" >> "$GITHUB_ENV"
          echo "[fetch] data zip at: ${GITHUB_WORKSPACE}/${TARGET}"

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYVER }}

      - name: Unpack code and data
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${RUN_DIR}" "${DATA_DIR}" "${OUT_DIR}"
          unzip -q "${CODE_ZIP_ABS}" -d "${RUN_DIR}"
          unzip -q "${DATA_ZIP_ABS}" -d "${DATA_DIR}"
          echo "[debug] data listing:"
          find "${DATA_DIR}" -maxdepth 2 -type f -name "*.csv" -print || true

      - name: Install deps
        shell: bash
        working-directory: ${{ env.RUN_DIR }}
        run: |
          set -euo pipefail
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy scikit-learn pyyaml
          fi

      - name: Detect CSV and preflight (ABS)
        shell: bash
        run: |
          set -euo pipefail
          FOUND="$(find "${{ env.DATA_DIR }}" -type f -name "${{ github.event.inputs.CSV_GLOB }}" | head -n 1 || true)"
          if [ -z "$FOUND" ]; then
            echo "::error::CSV not found: ${{ github.event.inputs.CSV_GLOB }}"
            exit 64
          fi
          CSV_ABS="${GITHUB_WORKSPACE}/${FOUND}"
          echo "CSV_PATH=${CSV_ABS}" >> "$GITHUB_ENV"
          echo "[debug] CSV_PATH=$CSV_ABS"
          python "${{ env.RUN_DIR }}/scripts/preflight_strict.py" "$CSV_ABS"

      - name: Run backtest (unified entry)
        shell: bash
        working-directory: ${{ env.RUN_DIR }}
        run: |
          set -euo pipefail
          export PYTHONPATH="${PWD}"
          python run_4u.py --data_path "${{ env.CSV_PATH }}" --out_dir "${{ github.workspace }}/${{ env.OUT_DIR }}"
          ls -l "${{ github.workspace }}/${{ env.OUT_DIR }}"

      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: backtest-output
          path: |
            ${{ env.OUT_DIR }}/summary.json
            ${{ env.OUT_DIR }}/gating_debug.json
            ${{ env.OUT_DIR }}/preds_test.csv
            ${{ env.OUT_DIR }}/trades.csv
            ${{ env.OUT_DIR }}/preflight.json