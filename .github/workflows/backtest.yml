name: Run backtest (v1.0.9)

on:
  workflow_dispatch:
    inputs:
      CODE_ZIP:
        description: "Code zip at repo root (e.g. trade_v1.0.8.zip)"
        required: true
        default: trade_v1.0.8.zip
      DATA_ZIP:
        description: "Data zip at repo root"
        required: true
        default: ETHUSDT_1min_2020_2025.zip
      CSV_GLOB:
        description: "CSV glob inside data dir"
        required: true
        default: "*ETHUSDT*1min*2020*2025*.csv"

permissions:
  contents: read

env:
  PY: "3.11"
  RUN_DIR: tmp/trade
  DATA_DIR: tmp/data
  OUT_DIR: _out_4u/run
  # ======= 반드시 실제 커밋 SHA로 바꿔서 사용 =======
  CHECKOUT_SHA: 11bd71901b2cbc3cb3cbbf5b1b973078d1b96b7a
  SETUP_PYTHON_SHA: a26af69be951a213d495a4c3e4e4022e16d87065
  UPLOAD_ARTIFACT_SHA: ea165f8d65b6e0b1f71c5e3cd2a1f1e166d0ad2d
  # ===============================================

jobs:
  run-backtest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (pinned)
        uses: actions/checkout@${{ env.CHECKOUT_SHA }}

      - name: Setup Python (pinned)
        uses: actions/setup-python@${{ env.SETUP_PYTHON_SHA }}
        with:
          python-version: ${{ env.PY }}

      - name: Prepare dirs & unzip code/data
        shell: bash
        run: |
          set -euo pipefail
          rm -rf "$RUN_DIR" "$DATA_DIR" "$OUT_DIR"
          mkdir -p "$RUN_DIR" "$DATA_DIR" "$OUT_DIR"
          unzip -o "${{ github.event.inputs.CODE_ZIP }}" -d "$RUN_DIR"
          unzip -o "${{ github.event.inputs.DATA_ZIP }}" -d "$DATA_DIR"

      - name: Install deps (requirements.txt if present)
        shell: bash
        working-directory: ${{ env.RUN_DIR }}
        run: |
          set -euo pipefail
          python3 -m pip -q install -U pip
          if [ -f requirements.txt ]; then
            python3 -m pip -q install -r requirements.txt
          else
            python3 -m pip -q install pandas numpy scikit-learn pyyaml
          fi

      - name: Detect CSV & export CSV_PATH
        shell: bash
        env:
          CSV_GLOB_IN: ${{ github.event.inputs.CSV_GLOB }}
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          base="$DATA_DIR"
          pat="${CSV_GLOB_IN:-**/*.csv}"
          mapfile -t matches < <(compgen -G "$base/$pat" || true)
          if [ ${#matches[@]} -eq 0 ]; then
            mapfile -t matches < <(compgen -G "$base"/**/*.csv || true)
          fi
          if [ ${#matches[@]} -eq 0 ]; then
            echo "ERROR: No CSV found under $base" >&2; exit 2
          fi
          p="${matches[0]}"
          ABS=$(python3 -c "import os,sys;print(os.path.abspath(sys.argv[1]))" "$p")
          echo "CSV_PATH=$ABS" | tee -a "$GITHUB_ENV"
          echo "Using CSV_PATH=$ABS"

      - name: Preflight columns (quick)
        shell: bash
        run: |
          set -euo pipefail
          python3 - "$CSV_PATH" <<'PY'
import sys, os, pandas as pd
p = sys.argv[1] if len(sys.argv)>1 else os.environ.get("CSV_PATH")
if not p or not os.path.exists(p):
    print("ERROR: CSV_PATH missing or not exists:", p); sys.exit(1)
df = pd.read_csv(p, nrows=2)
need = {'open_time','open','high','low','close','volume'}
cols = {str(c).lower() for c in df.columns}
miss = need - cols
if miss:
    print("ERROR: Missing base columns:", sorted(miss)); sys.exit(1)
print("OK: Columns present:", sorted(cols))
PY

      - name: Choose entrypoint & run
        shell: bash
        working-directory: ${{ env.RUN_DIR }}
        run: |
          set -euo pipefail
          mkdir -p "$OUT_DIR"
          [ -f "$OUT_DIR/gating_debug.json" ] || echo "{}" > "$OUT_DIR/gating_debug.json"
          ENTRY=""
          for c in "run_4u.py" "backtest/run_4u.py" "run.py" "backtest/runner.py"; do
            if [ -f "$c" ]; then ENTRY="$c"; break; fi
          done
          if [ -z "$ENTRY" ]; then
            echo "ERROR: backtest entry not found under $PWD" >&2; exit 3
          fi
          echo "Using entry: $ENTRY"
          python3 "$ENTRY" --data_path "$CSV_PATH"

      - name: Upload artifacts (pinned)
        uses: actions/upload-artifact@${{ env.UPLOAD_ARTIFACT_SHA }}
        with:
          name: backtest-output
          path: |
            ${{ env.OUT_DIR }}/summary.json
            ${{ env.OUT_DIR }}/gating_debug.json
            ${{ env.OUT_DIR }}/preds_test.csv
            ${{ env.OUT_DIR }}/trades.csv
          if-no-files-found: warn