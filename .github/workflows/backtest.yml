name: Backtest

on:
  workflow_dispatch:
    inputs:
      trade_zip:
        description: trade code zip at repo root
        required: true
        default: trade_v1.0.6_full_patched.zip
      data_zip:
        description: market data zip at repo root
        required: true
        default: ETHUSDT_1min_2020_2025.zip
      csv_glob:
        description: CSV filename glob (inside data zip)
        required: true
        default: "*ETHUSDT*1min*2020*2025*.csv"
      out_dir:
        description: output directory
        required: true
        default: _out_4u/run
      python_version:
        description: Python version
        required: true
        default: "3.11"

jobs:
  run-backtest:
    runs-on: ubuntu-latest
    env:
      RUN_DIR: tmp/trade
      DATA_DIR: tmp/data
      TRADE_ZIP: ${{ github.event.inputs.trade_zip }}
      DATA_ZIP:  ${{ github.event.inputs.data_zip }}
      CSV_GLOB:  ${{ github.event.inputs.csv_glob }}
      OUT_DIR:   ${{ github.event.inputs.out_dir }}
      PYVER:     ${{ github.event.inputs.python_version }}

    steps:
      # 1) Checkout (보안 규칙 충족: SHA 고정)
      - name: Checkout (pinned)
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      # 2) Zip 풀기 (Python 세팅보다 먼저!)
      - name: Prepare & unzip
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${RUN_DIR}" "${DATA_DIR}" "${OUT_DIR}"
          test -f "${TRADE_ZIP}" || { echo "❌ missing ${TRADE_ZIP}"; exit 1; }
          test -f "${DATA_ZIP}"  || { echo "❌ missing ${DATA_ZIP}"; exit 1; }
          unzip -q "${TRADE_ZIP}" -d "${RUN_DIR}"
          unzip -q "${DATA_ZIP}"  -d "${DATA_DIR}"

      # 3) 코드 루트 탐지 (zip 내부 어디에 풀렸든 backtest/engine.py 기준으로)
      - name: Detect code root
        shell: bash
        run: |
          set -euo pipefail
          found=$(find "${RUN_DIR}" -type f -path "*/backtest/engine.py" | head -n1 || true)
          if [ -z "$found" ]; then
            echo "❌ not found: backtest/engine.py under ${RUN_DIR}"
            find "${RUN_DIR}" -maxdepth 3 -type d -print
            exit 1
          fi
          CODE_DIR=$(dirname "$(dirname "$found")")
          echo "CODE_DIR=${CODE_DIR}" | tee -a "$GITHUB_ENV"

      # 4) CSV 절대경로 결정 (상대경로 때문에 터지는 문제 방지)
      - name: Detect CSV (absolute path)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob globstar
          CAND=( ${DATA_DIR}/${CSV_GLOB} )
          if (( ${#CAND[@]} == 0 )); then CAND=( ${DATA_DIR}/**/*.csv ); fi
          if (( ${#CAND[@]} == 0 )); then echo "❌ No CSV found under ${DATA_DIR}"; exit 1; fi
          ABS_CSV="$(readlink -f "${CAND[0]}" || echo "${GITHUB_WORKSPACE}/${CAND[0]}")"
          echo "ABS_CSV=${ABS_CSV}" | tee -a "$GITHUB_ENV"

      # 5) Python 세팅 (이제 zip 내부 req를 캐시 키로 사용)
      - name: Setup Python (pinned)
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYVER }}
          cache: pip
          cache-dependency-path: ${{ env.CODE_DIR }}/requirements.txt

      # 6) 의존성 설치 (pyyaml 포함)
      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -V
          python -m pip install -U pip
          python -m pip install -r "${CODE_DIR}/requirements.txt"

      # 7) 백테스트 실행
      - name: Run backtest
        working-directory: ${{ env.CODE_DIR }}
        shell: bash
        run: |
          set -euo pipefail
          python run_4u.py --data_path "${ABS_CSV}" --out_dir "${GITHUB_WORKSPACE}/${OUT_DIR}"

      # 8) 결과 업로드 (SHA 고정)
      - name: Upload artifacts (pinned)
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8
        with:
          name: backtest-output
          path: |
            ${{ env.OUT_DIR }}/summary.json
            ${{ env.OUT_DIR }}/gating_debug.json
            ${{ env.OUT_DIR }}/trades.csv
            ${{ env.OUT_DIR }}/preds_test.csv