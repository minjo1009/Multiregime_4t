name: Backtest

on:
  workflow_dispatch:
    inputs:
      TRADE_ZIP:
        description: Code zip at repo root
        required: true
        default: "trade_v1.0.7_full.zip"
      DATA_ZIP:
        description: Data zip at repo root
        required: true
        default: "ETHUSDT_1min_2020_2025.zip"
      CSV_GLOB:
        description: CSV glob inside DATA_DIR
        required: true
        default: "*ETHUSDT*1min*2020*2025*.csv"
      OUT_DIR:
        description: Output directory
        required: true
        default: "_out_4u/run"

jobs:
  run-backtest:
    runs-on: ubuntu-latest
    permissions: { contents: read }

    env:
      REPO_DIR: repo
      RUN_DIR: tmp/trade
      DATA_DIR: tmp/data
      OUT_DIR: ${{ inputs.OUT_DIR }}
      TRADE_ZIP: ${{ inputs.TRADE_ZIP }}
      DATA_ZIP: ${{ inputs.DATA_ZIP }}
      CSV_GLOB: ${{ inputs.CSV_GLOB }}

    steps:
      # — Manual checkout (조직 정책: checkout 액션 금지시)
      - name: Manual checkout (policy-safe)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$REPO_DIR"
          git -C "$REPO_DIR" init
          git -C "$REPO_DIR" remote add origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
          git -C "$REPO_DIR" fetch --depth 1 origin "${GITHUB_SHA:-${GITHUB_REF##*/}}"
          git -C "$REPO_DIR" checkout -q FETCH_HEAD
          git -C "$REPO_DIR" rev-parse --short HEAD
          ls -al "$REPO_DIR"

      # — Unzip code & data; 필수파일 검증
      - name: Unpack zips and verify structure
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUN_DIR" "$DATA_DIR" "$OUT_DIR"
          cp "$REPO_DIR/${TRADE_ZIP}" . || { echo "❌ trade zip not found: ${TRADE_ZIP}"; exit 1; }
          cp "$REPO_DIR/${DATA_ZIP}"  . || { echo "❌ data zip not found: ${DATA_ZIP}"; exit 1; }
          unzip -q "$TRADE_ZIP" -d "$RUN_DIR"
          unzip -q "$DATA_ZIP"  -d "$DATA_DIR"
          echo "== trade tree =="; ls -al "$RUN_DIR"
          echo "== data tree =="; ls -al "$DATA_DIR"
          test -f "$RUN_DIR/requirements.txt"    || { echo "❌ requirements.txt missing"; exit 1; }
          test -f "$RUN_DIR/run_4u.py"           || { echo "❌ run_4u.py missing"; exit 1; }
          test -f "$RUN_DIR/backtest/engine.py"  || { echo "❌ backtest/engine.py missing"; exit 1; }
          test -f "$RUN_DIR/conf/config.yml"     || { echo "❌ conf/config.yml missing"; exit 1; }

      # — Python 설치 (requirements 경로로 캐시 고정)
      - name: Setup Python (pinned; cache path = tmp/trade/requirements.txt)
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: tmp/trade/requirements.txt
          check-latest: false
          allow-prereleases: false
          update-environment: true

      - name: Install requirements
        shell: bash
        working-directory: ${{ env.RUN_DIR }}
        run: |
          set -euo pipefail
          python -V
          python -m pip install -U pip
          python -m pip install -r requirements.txt
          python - <<'PY'
          import yaml, json, numpy, pandas, sklearn, sys
          print("deps OK:", "yaml", getattr(yaml,'__version__','?'),
                "| numpy", numpy.__version__,
                "| pandas", pandas.__version__,
                "| sklearn", sklearn.__version__,
                "| py", sys.version.split()[0])
          PY

      # — sklearn 1.4/1.5 호환 스모크
      - name: sklearn smoke (1.4/1.5 호환)
        shell: bash
        working-directory: ${{ env.RUN_DIR }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import inspect, sklearn
          from sklearn.calibration import CalibratedClassifierCV as C
          p=set(getattr(__import__('inspect').signature(C),'parameters',{}).keys())
          print("sklearn", sklearn.__version__, "| C param:", "estimator" if 'estimator' in p else "base_estimator")
          PY

      # — CSV 프리플라이트
      - name: Preflight CSV
        shell: bash
        run: |
          set -euo pipefail
          CSV_PATH="$(ls ${DATA_DIR}/${CSV_GLOB} 2>/dev/null | head -n1 || true)"
          [ -n "$CSV_PATH" ] || CSV_PATH="$(ls ${DATA_DIR}/*.csv 2>/dev/null | head -n1 || true)"
          [ -n "$CSV_PATH" ] || { echo "❌ No CSV found in ${DATA_DIR}"; exit 1; }
          echo "Using CSV_PATH=${CSV_PATH}"
          python - <<'PY'
          import pandas as pd, os, sys
          p=os.environ['CSV_PATH']
          df=pd.read_csv(p, nrows=2)
          need={'open_time','open','high','low','close','volume'}
          miss=need-set(df.columns)
          if miss:
              print("❌ Missing base columns:", miss); sys.exit(1)
          print("✅ Columns OK:", sorted(df.columns))
          PY
          echo "CSV_PATH=${CSV_PATH}" >> $GITHUB_ENV

      # — 백테스트 실행
      - name: Run backtest
        shell: bash
        working-directory: ${{ env.RUN_DIR }}
        run: |
          set -euo pipefail
          python run_4u.py --data_path "${CSV_PATH}" --config "conf/config.yml" --out_dir "${OUT_DIR}"
          echo "---- gating debug (head) ----"
          [ -f "${OUT_DIR}/gating_debug.json" ] || echo "{}" > "${OUT_DIR}/gating_debug.json"
          head -n 60 "${OUT_DIR}/gating_debug.json" || true
          ls -al "${OUT_DIR}"

      # — 아티팩트 업로드 (SHA pinned)
      - name: Upload artifacts (pinned)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: backtest-output
          path: |
            ${{ env.OUT_DIR }}/summary.json
            ${{ env.OUT_DIR }}/gating_debug.json
            ${{ env.OUT_DIR }}/preds_test.csv
            ${{ env.OUT_DIR }}/trades.csv
            ${{ env.OUT_DIR }}/charts/
          if-no-files-found: warn
          retention-days: 30