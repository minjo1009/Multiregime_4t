name: Run backtest (v1.0.8)

on:
  workflow_dispatch:
    inputs:
      CODE_ZIP:
        description: Code zip at repo root
        required: true
        default: trade_v1.0.8.zip
      DATA_ZIP:
        description: Data zip at repo root
        required: true
        default: ETHUSDT_1min_2020_2025.zip
      CSV_GLOB:
        description: CSV glob inside data dir
        required: true
        default: "*ETHUSDT*1min*2020*2025*.csv"
      PY:
        description: Python version
        required: true
        default: "3.11"

permissions:
  contents: read

jobs:
  run-backtest:
    runs-on: ubuntu-latest
    env:
      RUN_DIR: tmp/trade
      DATA_DIR: tmp/data
      OUT_DIR: _out_4u/run
      PY: ${{ github.event.inputs.PY }}

    steps:
      - name: Checkout (safe tag)
        uses: actions/checkout@v4

      - name: Setup Python (safe tag)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY }}

      - name: Prepare dirs & unzip code/data
        shell: bash
        env:
          CODE_ZIP: ${{ github.event.inputs.CODE_ZIP }}
          DATA_ZIP: ${{ github.event.inputs.DATA_ZIP }}
        run: |
          set -euo pipefail
          rm -rf "$RUN_DIR" "$DATA_DIR" "$OUT_DIR"
          mkdir -p "$RUN_DIR" "$DATA_DIR" "$OUT_DIR"
          unzip -o "$CODE_ZIP" -d "$RUN_DIR"  >/dev/null
          unzip -o "$DATA_ZIP" -d "$DATA_DIR" >/dev/null
          ls -al "$RUN_DIR" | sed -n '1,120p'
          ls -al "$DATA_DIR" | sed -n '1,120p'

      - name: Install deps (prefer project requirements)
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip -q install -U pip
          if [ -f "$RUN_DIR/requirements.txt" ]; then
            python3 -m pip -q install -r "$RUN_DIR/requirements.txt"
          else
            python3 -m pip -q install pandas numpy scikit-learn pyyaml
          fi

      - name: Detect CSV path
        shell: bash
        env:
          CSV_GLOB_IN: ${{ github.event.inputs.CSV_GLOB }}
        run: |
          set -euo pipefail
          cat > detect_csv.py <<'PY'
          import os, glob, sys
          base = os.environ['DATA_DIR']
          pat  = os.environ.get('CSV_GLOB_IN','').strip()
          c = []
          if pat:
              c = glob.glob(os.path.join(base,'**',pat), recursive=True)
          if not c:
              c = glob.glob(os.path.join(base,'**','*.csv'), recursive=True)
          if not c:
              print(f"ERROR: no CSV found under {base}", file=sys.stderr)
              sys.exit(44)
          c.sort()
          print(os.path.abspath(c[0]))
          PY
          CSV_PATH=$(python3 detect_csv.py)
          echo "CSV_PATH=$CSV_PATH" >> "$GITHUB_ENV"
          echo "Using CSV_PATH=$CSV_PATH"

      - name: Preflight columns
        shell: bash
        run: |
          set -euo pipefail
          cat > preflight.py <<'PY'
          import os, sys, pandas as pd
          p = os.environ.get("CSV_PATH")
          if not p or not os.path.exists(p):
              print(f"ERROR: CSV_PATH missing or not exists: {p}", file=sys.stderr)
              sys.exit(45)
          df = pd.read_csv(p, nrows=2)
          need = {'open_time','open','high','low','close','volume'}
          cols = {c.lower() for c in df.columns}
          miss = sorted(need - cols)
          if miss:
              print("ERROR: missing base columns:", miss, file=sys.stderr)
              sys.exit(46)
          print("Columns OK:", sorted(df.columns))
          PY
          python3 preflight.py

      - name: Run backtest
        shell: bash
        run: |
          set -euo pipefail
          cat > run_backtest.sh <<'SH'
          set -euo pipefail
          R="$RUN_DIR"; CSV="$CSV_PATH"; OUT="$OUT_DIR"
          mkdir -p "$OUT"
          [ -f "$OUT/gating_debug.json" ] || echo "{}" > "$OUT/gating_debug.json"
          entry=""
          for f in run_4u.py backtest/run_4u.py run.py backtest/runner.py; do
            if [ -f "$R/$f" ]; then entry="$f"; break; fi
          done
          if [ -z "$entry" ]; then
            echo "ERROR: no entrypoint in $R" >&2; exit 47
          fi
          set +e
          python3 "$R/$entry" --data_path "$CSV" --out_dir "$OUT"
          code=$?
          echo "Backtest exit code: $code"
          exit $code
          SH
          bash run_backtest.sh

      - name: Upload artifacts (safe tag)
        uses: actions/upload-artifact@v4
        with:
          name: backtest-output
          path: |
            _out_4u/run/summary.json
            _out_4u/run/gating_debug.json
            _out_4u/run/preds_test.csv
            _out_4u/run/trades.csv
          if-no-files-found: warn