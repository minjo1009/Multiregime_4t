name: Scapler_Backtest (ETHUSDT 1m)

on:
  push:
    paths:
      - '**.zip'
      - '**.py'
      - 'requirements.txt'
      - '.github/workflows/backtest.yml'
  workflow_dispatch: {}

jobs:
  backtest:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        symbol: [ETHUSDT]
        timeframe: ['1m']
        slippage: [0.0005]     # í•„ìš”ì‹œ ì¡°ì •
        fee: [0.0004]          # ê±°ëž˜ì†Œ taker/maker ìˆ˜ìˆ˜ë£Œì— ë§žê²Œ ì¡°ì •
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip

      - name: Unzip all .zip in repo root
        run: |
          shopt -s nullglob
          mkdir -p unzipped
          for z in *.zip; do
            echo "Unzipping $z"
            mkdir -p "unzipped/${z%.zip}"
            unzip -oq "$z" -d "unzipped/${z%.zip}"
          done

          # ì „ëžµ zip ì•ˆì— *.py ìžˆìœ¼ë©´ ë£¨íŠ¸ë¡œ ë³µì‚¬(ì´ë¯¸ ìžˆìœ¼ë©´ ìœ ì§€)
          for d in unzipped/*; do
            if compgen -G "$d/*.py" > /dev/null; then
              cp -rn "$d"/* .
            fi
          done

      - name: Locate ETH 1m data file
        id: data
        run: |
          # ê°€ìž¥ ê·¸ëŸ´ë“¯í•œ íŒŒì¼ ìžë™ íƒì§€ (csv ìš°ì„ , ì—†ìœ¼ë©´ parquet)
          DATA_FILE=$( { find unzipped -type f -iregex '.*ETH.*1.*m.*\.csv$' -o -iregex '.*ETHUSDT.*1.*m.*\.csv$'; } | head -n1 || true)
          if [ -z "$DATA_FILE" ]; then
            DATA_FILE=$( { find unzipped -type f -iregex '.*ETH.*1.*m.*\.parquet$' -o -iregex '.*ETHUSDT.*1.*m.*\.parquet$'; } | head -n1 || true)
          fi
          if [ -z "$DATA_FILE" ]; then
            echo "âŒ ETH 1ë¶„ë´‰ ë°ì´í„°(csv/parquet) ìžë™íƒì§€ ì‹¤íŒ¨. íŒŒì¼ëª…ì„ ETH/ETHUSDT & 1m/1min í¬í•¨í•˜ê²Œ í•´ì¤˜."
            exit 1
          fi
          echo "data_file=$DATA_FILE" >> $GITHUB_OUTPUT
          echo "âœ… DATA_FILE=$DATA_FILE"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # ê¸°ë³¸ ë°±í…ŒìŠ¤íŠ¸ ìŠ¤íƒ(í•„ìš” íŒ¨í‚¤ì§€ ë¯¸ì •ì¼ ë•Œ ì•ˆì „ë§)
            pip install backtrader pandas numpy ta matplotlib
          fi

      - name: Decide RUN_CMD (auto-detect entry)
        id: run
        env:
          SYMBOL: ${{ matrix.symbol }}
          TIMEFRAME: ${{ matrix.timeframe }}
          DATA_FILE: ${{ steps.data.outputs.data_file }}
          SLIPPAGE: ${{ matrix.slippage }}
          FEE: ${{ matrix.fee }}
        run: |
          set -e
          # 1) ë£¨íŠ¸ì˜ backtest.py
          if [ -f "./backtest.py" ]; then
            CMD="python backtest.py --symbol ${SYMBOL} --timeframe ${TIMEFRAME} --data \"${DATA_FILE}\" --slippage ${SLIPPAGE} --fee ${FEE} --outdir output/${SYMBOL}_${TIMEFRAME}"
          # 2) ì–´ë–¤ ë””ë ‰í† ë¦¬ë“  backtest*.py ì¤‘ í•˜ë‚˜
          elif ls **/backtest*.py 1> /dev/null 2>&1; then
            FILE=$(ls **/backtest*.py | head -n1)
            CMD="python \"$FILE\" --symbol ${SYMBOL} --timeframe ${TIMEFRAME} --data \"${DATA_FILE}\" --slippage ${SLIPPAGE} --fee ${FEE} --outdir output/${SYMBOL}_${TIMEFRAME}"
          # 3) Makefile target
          elif [ -f "Makefile" ] && grep -qE '(^backtest:)|(^run-backtest:)' Makefile; then
            CMD="make backtest SYMBOL=${SYMBOL} TIMEFRAME=${TIMEFRAME} DATA='${DATA_FILE}' SLIPPAGE=${SLIPPAGE} FEE=${FEE}"
          else
            echo "âŒ ë°±í…ŒìŠ¤íŠ¸ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸(backtest.py, **/backtest*.py, ë˜ëŠ” Makefile target)ê°€ ì—†ìŒ."
            echo "ðŸ‘‰ ë ˆí¬ ë£¨íŠ¸ì— backtest.py ë‘ê±°ë‚˜, Makefileì— backtest íƒ€ê²Ÿì„ ë§Œë“¤ì–´ì¤˜."
            exit 1
          fi
          echo "cmd=$CMD" >> $GITHUB_OUTPUT
          echo "â–¶ $CMD"

      - name: Run backtest
        run: ${{ steps.run.outputs.cmd }}

      - name: Upload artifacts (results/reports/output)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backtest-${{ matrix.symbol }}-${{ matrix.timeframe }}
          path: |
            output/**
            results/**
            reports/**
          if-no-files-found: ignore
