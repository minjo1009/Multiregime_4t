<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Trade4V Viewer Pro v2.2 (Schema v1)</title>
  <style>
    :root { --bg:#0b1220; --panel:#0e1628; --card:#111827; --muted:#9ca3af; --fg:#e5e7eb; --accent:#60a5fa; --good:#10b981; --bad:#ef4444; }
    html, body { height: 100%; background: var(--bg); color: var(--fg); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { display:flex; height:100%; }
    .side { width:360px; background: var(--panel); padding:16px; border-right:1px solid #1f2937; overflow:auto; }
    .main { flex:1; display:flex; flex-direction:column; gap:12px; padding:16px; overflow:auto; }
    h1 { margin:0 0 12px; font-size:18px; font-weight:600; }
    .section { margin-bottom:16px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { background:#1f2937; border:1px solid #374151; color:#e5e7eb; border-radius:8px; padding:8px 10px; cursor:pointer; }
    .btn:hover { border-color:#4b5563; }
    .input, select { background:#0f172a; color:#e5e7eb; border:1px solid #334155; border-radius:8px; padding:8px 10px; }
    .card { background: var(--card); border:1px solid #1f2937; border-radius:12px; padding:12px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:10px; }
    .muted { color: var(--muted); font-size:12px; }
    .kpi { font-size:22px; font-weight:700; }
    .drpz { border:2px dashed #334155; border-radius:12px; padding:12px; text-align:center; color:#9ca3af; }
    .preset .btn { font-size:12px; padding:6px 8px; }
    .toast { position:fixed; right:16px; bottom:16px; background:#111827; border:1px solid #374151; border-radius:10px; padding:10px 12px; color:#e5e7eb; opacity:0.95; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:6px 8px; border-bottom:1px solid #1f2937; font-size:12px; text-align:right; }
    th:first-child, td:first-child { text-align:left; }
    .pos { color: var(--good); } .neg { color: var(--bad); }
  </style>
  <!-- Pinned versions -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0" integrity="" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js" integrity="" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" integrity="" crossorigin="anonymous"></script>
</head>
<body>
<div class="wrap">
  <aside class="side">
    <h1>Trade4V Viewer Pro v2.2</h1>
    <div class="section">
      <div class="muted">파일 드래그 앤 드롭 (창 어디든 가능)</div>
      <div id="drop" class="drpz">여기로 <b>preds.csv</b> + <b>metrics_oos.json</b> 드롭</div>
      <div style="height:8px"></div>
      <div class="row"><input class="input" type="file" id="predsFile" accept=".csv" /><input class="input" type="file" id="metricsFile" accept="application/json" /></div>
      <div class="row"><button class="btn" id="btnForceRefresh">강제 새로고침</button><span id="status" class="muted">-</span></div>
    </div>
    <div class="section">
      <div class="muted">URL로 불러오기 (raw 링크)</div>
      <input class="input" id="predsURL" placeholder="preds.csv raw URL">
      <input class="input" id="metricsURL" placeholder="metrics.json raw URL">
      <div class="row"><button class="btn" id="btnLoadURL">불러오기</button><span id="loadMsg" class="muted"></span></div>
    </div>
    <div class="section preset">
      <div class="muted">기간 빠른 선택</div>
      <div class="row">
        <button class="btn" data-range="1D">1D</button>
        <button class="btn" data-range="1W">1W</button>
        <button class="btn" data-range="1M">1M</button>
        <button class="btn" data-range="3M">3M</button>
        <button class="btn" data-range="YTD">YTD</button>
        <button class="btn" data-range="ALL">ALL</button>
      </div>
    </div>
    <div class="section">
      <div class="muted">기간 수동 선택</div>
      <div class="row">
        <input class="input" id="start" type="datetime-local">
        <input class="input" id="end" type="datetime-local">
      </div>
      <div class="row">
        <button class="btn" id="btnApplyRange">적용</button>
        <button class="btn" id="btnResetZoom">줌 리셋</button>
        <button class="btn" id="btnResetAll">전체 리셋</button>
      </div>
    </div>
    <div class="section">
      <div class="muted">레짐 필터</div>
      <div class="row">
        <label><input type="checkbox" id="rid0" checked> R0</label>
        <label><input type="checkbox" id="rid1" checked> R1</label>
        <label><input type="checkbox" id="rid2" checked> R2</label>
      </div>
    </div>
    <div class="section">
      <div class="muted">표시 요소</div>
      <div class="row" style="flex-direction:column; align-items:flex-start;">
        <label><input type="checkbox" id="showEquity" checked> 누적 PnL 라인</label>
        <label><input type="checkbox" id="showBars" checked> 일별 PnL 바</label>
        <label><input type="checkbox" id="showScatter" checked> EV vs 실현 산포</label>
        <label><input type="checkbox" id="showHist" checked> EV 히스토그램</label>
        <label><input type="checkbox" id="showDD" checked> 드로우다운</label>
      </div>
    </div>
    <div class="section">
      <div class="muted">스무딩(Equity)</div>
      <select id="smooth" class="input">
        <option value="1">x1</option>
        <option value="5">x5</option>
        <option value="15">x15</option>
      </select>
    </div>
    <div class="section">
      <div class="muted">스키마</div>
      <div id="schemaInfo" class="muted">-</div>
    </div>
  </aside>

  <main class="main">
    <div class="grid">
      <div class="card"><div class="muted">Trades</div><div id="k_trades" class="kpi">-</div></div>
      <div class="card"><div class="muted">Hit rate</div><div id="k_hit" class="kpi">-</div></div>
      <div class="card"><div class="muted">PnL (sum)</div><div id="k_pnl" class="kpi">-</div></div>
      <div class="card"><div class="muted">EV≥0 ratio</div><div id="k_evpos" class="kpi">-</div></div>
      <div class="card"><div class="muted">Eff (real/EV)</div><div id="k_eff" class="kpi">-</div></div>
      <div class="card"><div class="muted">Eff (real/EV·size)</div><div id="k_effw" class="kpi">-</div></div>
    </div>
    <div id="panelEquity" class="card"><canvas id="equity" height="120"></canvas></div>
    <div id="panelBars" class="card"><canvas id="barPnL" height="120"></canvas></div>
    <div id="panelDD" class="card"><canvas id="drawdown" height="120"></canvas></div>
    <div id="panelScatter" class="card"><canvas id="scatter" height="140"></canvas></div>
    <div id="panelHist" class="card"><canvas id="hist" height="120"></canvas></div>
    <div class="card">
      <div class="muted">EV Deciles</div>
      <table id="deciles"><thead><tr><th>Bucket</th><th>Count</th><th>EV Sum</th><th>Realized Sum</th><th>Eff</th></tr></thead><tbody></tbody></table>
    </div>
  </main>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
// ===== Chart.js safe plugin registration =====
(function(){
  try{
    const zoom = window["chartjs-plugin-zoom"] || window.ChartZoom || window.chartjsPluginZoom;
    if(zoom && window.Chart && window.Chart.register){
      window.Chart.register(zoom);
      console.log("[viewer] zoom plugin registered");
    }else{
      console.warn("[viewer] zoom plugin not found; charts will render without zoom.");
    }
  }catch(e){
    console.warn("[viewer] zoom plugin registration failed:", e);
  }
})();
</script>

<script>
let RAW=null, MET=null, FILT=null, ALL=null, charts={};
const needCols = ["time","regime_id","H_row","ev_final","entry_flag","size","gross_event","net_event"];
const synonyms = {
  time: ["time","timestamp","open_time","date"],
  regime_id: ["regime_id","regime","state"],
  H_row: ["H_row","H_used","H","h_row","h_used","h"],
  ev_final: ["ev_final","ev_net","edge","pnl_pred","ev"],
  entry_flag: ["entry_flag","signal","enter","trade","flag"],
  size: ["size","kelly","weight","position","w","kelly_size"],
  gross_event: ["gross_event","event_gross","gross","ret_gross","gross_ret"],
  net_event: ["net_event","event_net","net","ret_net","net_ret","realized"]
};

function toast(msg){
  const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block';
  setTimeout(()=>{ t.style.display='none'; }, 2500);
}
function setStatus(msg){ document.getElementById('status').innerText = msg; }

function safeParseTime(v){
  if(typeof v === 'number'){ return new Date(v); }
  if(typeof v === 'string'){
    if(!/[zZ]|[+\-]\d{2}:\d{2}$/.test(v)) v = v.replace(' ', 'T') + 'Z';
    return new Date(v);
  }
  return new Date(v);
}

function mapHeaders(rows){
  if(!rows || !rows.length) return rows;
  const first = rows[0];
  const keys = Object.keys(first);
  const up = k=> k.toLowerCase().replace(/\s+/g,'');
  const dict = {};
  for(const req in synonyms){
    const cands = synonyms[req];
    for(const k of keys){
      const K = up(k);
      for(const c of cands){
        if(K === up(c)){ dict[req] = k; break; }
      }
      if(dict[req]) break;
    }
  }
  return rows.map(r=>{
    const o={};
    for(const req of Object.keys(synonyms)){
      const k = dict[req];
      if(k !== undefined){ o[req] = r[k]; }
    }
    for(const k in r){ if(!(k in o)) o[k]=r[k]; }
    return o;
  });
}

function adaptRows(rows){
  if(!rows || rows.length===0) return rows;
  rows = rows.map(obj=>{ const r={}; for(const k in obj){ r[k.trim()] = obj[k]; } return r; });
  rows = mapHeaders(rows);
  const has = k=> Object.prototype.hasOwnProperty.call(rows[0], k);
  let out = rows.map(r=>({...r}));
  if(!has("ev_final") && has("ev_net")) out = out.map(r=>({...r, ev_final:Number(r.ev_net)}));
  const miss = needCols.filter(c=> !(c in out[0]));
  if(miss.length) throw new Error("필수 컬럼 누락: "+miss.join(", "));
  return out;
}

function derive(rows, start=null, end=null, ridMask={0:true,1:true,2:true}, smooth=1){
  const p = rows.map(r=>({ ...r,
    time: safeParseTime(r.time),
    regime_id: Number(r.regime_id),
    H_row: Number(r.H_row||1),
    ev_final: Number(r.ev_final||0),
    entry_flag: Number(r.entry_flag||0),
    size: Number(r.size||0),
    gross_event: Number(r.gross_event||0),
    net_event: Number(r.net_event||0),
  })).filter(r=> ridMask[r.regime_id]);
  const p2 = p.filter(r=> (!start || r.time>=start) && (!end || r.time<=end));

  const selected = p2.filter(r=> r.entry_flag===1);
  const withSize = selected.map(r=> ({...r, pnl: r.net_event*r.size, exit: new Date(r.time.getTime()+r.H_row*60*1000)}));

  const pnl = withSize.reduce((a,r)=>a+r.pnl,0);
  const evSum = withSize.reduce((a,r)=>a+r.ev_final,0);
  const evWSum= withSize.reduce((a,r)=>a+r.ev_final*r.size,0);
  const eff = evSum>0 ? pnl/evSum : 0;
  const effW= evWSum>0? pnl/evWSum: 0;
  const wins = withSize.filter(r=> r.gross_event>0).length;
  const hit = selected.length? wins/selected.length : 0;
  const evPos = p2.length? p2.filter(r=> r.ev_final>=0).length/p2.length : 0;

  const impulses = withSize.map(r=> ({ t:r.exit, v:r.pnl })).sort((a,b)=>a.t-b.t);
  let cum=0; const series = impulses.map(s=> ({ t:s.t, cum:(cum+=s.v) }));

  const dayMap={}; withSize.forEach(r=>{ const k=r.exit.toISOString().slice(0,10); dayMap[k]=(dayMap[k]||0)+r.pnl; });
  const days = Object.keys(dayMap).sort().map(k=> ({ day:k, pnl: dayMap[k] }));

  const scatter = withSize.map(r=> ({ x:r.ev_final, y:r.pnl }));

  const evs = p2.map(r=> r.ev_final);

  // Drawdown
  let peak = 0, eq=0, ddSeries=[];
  series.forEach(s=>{ eq=s.cum; peak=Math.max(peak, eq); ddSeries.push({t:s.t, dd: peak - eq}); });

  // Deciles
  const evSel = selected.map(r=> r.ev_final).slice().sort((a,b)=>a-b);
  const buckets = 10;
  let cuts=[]; for(let i=1;i<buckets;i++){ const q = i/buckets; const idx = Math.floor(q*(evSel.length-1)); cuts.push(evSel.length? evSel[idx]:0); }
  function bucketOf(v){ let b=0; while(b<cuts.length && v>cuts[b]) b++; return b; }
  const agg = Array.from({length:buckets},()=>({cnt:0, ev:0, real:0}));
  withSize.forEach(r=>{ const b = bucketOf(r.ev_final); agg[b].cnt++; agg[b].ev += r.ev_final; agg[b].real += r.pnl; });
  const dec = agg.map((g,i)=>({ bucket:`D${i+1}`, cnt:g.cnt, ev:g.ev, real:g.real, eff: (g.ev>0? g.real/g.ev:0) }));

  return { selected, pnl, hit, evPos, eff, effW, trades:selected.length, series, days, scatter, evs, ddSeries, deciles:dec, tmin: p2.length? p2[0].time : null, tmax: p2.length? p2[p2.length-1].time : null };
}

function mkChart(id, cfg){
  if(charts[id]) charts[id].destroy();
  charts[id] = new Chart(document.getElementById(id), cfg);
}

function draw(d){
  const $ = id=> document.getElementById(id);
  $("#k_trades").innerText = d.trades;
  $("#k_hit").innerText = (d.hit*100).toFixed(1)+"%";
  $("#k_pnl").innerText = d.pnl.toFixed(4);
  $("#k_evpos").innerText = (d.evPos*100).toFixed(1)+"%";
  $("#k_eff").innerText = d.eff.toFixed(3);
  $("#k_effw").innerText = d.effW.toFixed(3);

  const show = id=> document.getElementById(id).style.display = 'block';
  const hide = id=> document.getElementById(id).style.display = 'none';
  const on = id=> document.getElementById(id).checked;

  (on("showEquity")?show:hide)("panelEquity");
  (on("showBars")?show:hide)("panelBars");
  (on("showScatter")?show:hide)("panelScatter");
  (on("showHist")?show:hide)("panelHist");
  (on("showDD")?show:hide)("panelDD");

  // Equity
  if(on("showEquity")){
    const labels = d.series.map(s=> s.t);
    const data = d.series.map(s=> s.cum);
    const smooth = parseInt(document.getElementById("smooth").value||"1",10);
    let smData=data;
    if(smooth>1 && data.length>smooth){
      smData=[]; for(let i=0;i<data.length;i++){ const a=Math.max(0, i-smooth+1); const chunk=data.slice(a,i+1); smData.push(chunk.reduce((x,y)=>x+y,0)/chunk.length); }
    }
    mkChart('equity', {
      type:'line',
      data:{ labels, datasets:[{ label:'Cumulative PnL', data: smData, pointRadius:0 }]},
      options:{ parsing:false, scales:{ x:{ type:'time' } },
        plugins:{ zoom: (Chart.registry.plugins.get('zoom')? { zoom:{ wheel:{enabled:true}, pinch:{enabled:true}, mode:'x' }, pan:{ enabled:true, mode:'x' }, drag:{ enabled:true, modifierKey:'alt' } } : {}) }
      }
    });
  }

  if(on("showBars")){
    mkChart('barPnL', {
      type:'bar',
      data:{ labels: d.days.map(x=> x.day), datasets:[{ label:'Daily PnL', data: d.days.map(x=> x.pnl) }]},
      options:{ scales:{ x:{ ticks:{ maxRotation:0 } } } }
    });
  }

  if(on("showDD")){
    mkChart('drawdown', {
      type:'line',
      data:{ labels: d.ddSeries.map(s=> s.t), datasets:[{ label:'Drawdown', data: d.ddSeries.map(s=> s.dd), pointRadius:0 }]},
      options:{ parsing:false, scales:{ x:{ type:'time' } } }
    });
  }

  if(on("showScatter")){
    mkChart('scatter', {
      type:'scatter',
      data:{ datasets:[{ label:'EV vs Realized', data: d.scatter }]},
      options:{ scales:{ x:{ title:{display:true,text:'EV(final)'}}, y:{ title:{display:true,text:'Realized(net*size)'}} } }
    });
  }

  if(on("showHist")){
    const evs = d.evs.slice().sort((a,b)=>a-b);
    const bins = 30; const min = evs.length? evs[0]:0; const max = evs.length? evs[evs.length-1]:1;
    const step = (max-min)/(bins||1) || 1;
    const edges = Array.from({length:bins}, (_,i)=> min + i*step);
    const counts = Array.from({length:bins}, ()=>0);
    evs.forEach(v=>{ const idx = Math.max(0, Math.min(bins-1, Math.floor((v-min)/step))); counts[idx]++; });
    const centers = edges.map((e,i)=> e + step/2);
    mkChart('hist', { type:'bar', data:{ labels: centers, datasets:[{ label:'EV Histogram', data: counts }]}, options:{ scales:{ x:{ ticks:{ display:false }}} } });
  }

  // Deciles
  const tb = document.querySelector("#deciles tbody"); tb.innerHTML="";
  d.deciles.forEach(g=>{
    const tr=document.createElement("tr");
    const eff = (g.ev>0)? (g.real/g.ev) : 0;
    tr.innerHTML = `<td>${g.bucket}</td><td>${g.cnt}</td><td>${g.ev.toFixed(4)}</td><td class="${g.real>=0?'pos':'neg'}">${g.real.toFixed(4)}</td><td>${eff.toFixed(3)}</td>`;
    tb.appendChild(tr);
  });
}

function getFilters(){
  const s = document.getElementById("start").value;
  const e = document.getElementById("end").value;
  const start = s ? new Date(s) : null;
  const end   = e ? new Date(e) : null;
  const ridMask = {0:document.getElementById("rid0").checked, 1:document.getElementById("rid1").checked, 2:document.getElementById("rid2").checked};
  const smooth = parseInt(document.getElementById("smooth").value||"1",10);
  return { start, end, ridMask, smooth };
}

function refresh(){
  if(!ALL || !ALL.rows) return;
  const { start, end, ridMask, smooth } = getFilters();
  const d = derive(ALL.rows, start, end, ridMask, smooth);
  FILT = d;
  document.getElementById("schemaInfo").innerText = "viewer_schema: " + (ALL.metrics?.viewer_schema || "v1?");
  draw(d);
}

function afterLoad(){
  if(!RAW && !MET){ setStatus("-"); return; }
  const name1 = ALL?.names?.preds || "-";
  const name2 = ALL?.names?.metrics || "-";
  setStatus(`로드됨: ${name1} / ${name2} (rows=${(ALL.rows||[]).length||0})`);
  try{
    const rows = ALL.rows;
    if(rows && rows.length){
      const t0 = safeParseTime(rows[0].time);
      const t1 = safeParseTime(rows[rows.length-1].time);
      const toLocal = t=> new Date(t.getTime() - t.getTimezoneOffset()*60000).toISOString().slice(0,16);
      document.getElementById("start").value = toLocal(t0);
      document.getElementById("end").value   = toLocal(t1);
    }
  }catch(err){}
  refresh();
}

async function handleFiles(files){
  const arr = Array.from(files||[]);
  if(arr.length===0) return;
  let changed=false;
  for(const f of arr){
    try{
      if(f.name.endsWith(".csv")){
        const r = await new Promise((res,rej)=> Papa.parse(f,{header:true,dynamicTyping:true,complete:r=>res(r.data),error:rej}));
        RAW = adaptRows(r); changed=true;
        ALL = ALL || {}; ALL.rows = RAW; ALL.names = ALL.names || {}; ALL.names.preds = f.name;
      }else if(f.name.endsWith(".json")){
        const text = await f.text(); MET = JSON.parse(text); changed=true;
        ALL = ALL || {}; ALL.metrics = MET; ALL.names = ALL.names || {}; ALL.names.metrics = f.name;
      }else{
        toast("지원하지 않는 파일: "+f.name);
      }
    }catch(err){
      toast("로딩 실패: "+err.message);
      console.error(err);
    }
  }
  if(changed) afterLoad();
}

async function fetchText(url){ const r=await fetch(url, {cache:'no-store'}); if(!r.ok) throw new Error(r.statusText); return r.text(); }

// Inputs
document.getElementById("predsFile").addEventListener("change", e=> handleFiles(e.target.files));
document.getElementById("metricsFile").addEventListener("change", e=> handleFiles(e.target.files));
document.getElementById("btnForceRefresh").addEventListener("click", refresh);
["rid0","rid1","rid2","showEquity","showBars","showScatter","showHist","showDD","smooth"].forEach(id=>{
  document.getElementById(id).addEventListener("change", refresh);
});
document.querySelectorAll(".preset .btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    if(!ALL?.rows?.length) return;
    const rows = ALL.rows;
    const last = new Date(rows[rows.length-1].time);
    const first= new Date(rows[0].time);
    function minusDays(d){ const x = new Date(last); x.setDate(x.getDate()-d); return x; }
    let s=first, e=last;
    const label = btn.getAttribute("data-range");
    if(label==="1D") s = minusDays(1);
    if(label==="1W") s = minusDays(7);
    if(label==="1M") s = minusDays(30);
    if(label==="3M") s = minusDays(90);
    if(label==="YTD"){ s = new Date(last.getFullYear(),0,1); }
    const toLocal = t=> new Date(t.getTime() - t.getTimezoneOffset()*60000).toISOString().slice(0,16);
    document.getElementById("start").value = toLocal(s);
    document.getElementById("end").value   = toLocal(e);
    refresh();
  });
});
document.getElementById("btnApplyRange").addEventListener("click", refresh);
document.getElementById("btnResetZoom").addEventListener("click", ()=>{ try{ charts.equity.resetZoom(); }catch(e){} });
document.getElementById("btnResetAll").addEventListener("click", ()=>{
  document.getElementById("rid0").checked=true;
  document.getElementById("rid1").checked=true;
  document.getElementById("rid2").checked=true;
  document.getElementById("showEquity").checked=true;
  document.getElementById("showBars").checked=true;
  document.getElementById("showScatter").checked=true;
  document.getElementById("showHist").checked=true;
  document.getElementById("showDD").checked=true;
  document.getElementById("smooth").value="1";
  if(ALL?.rows?.length){
    const t0 = new Date(ALL.rows[0].time);
    const t1 = new Date(ALL.rows[ALL.rows.length-1].time);
    const toLocal = t=> new Date(t.getTime() - t.getTimezoneOffset()*60000).toISOString().slice(0,16);
    document.getElementById("start").value = toLocal(t0);
    document.getElementById("end").value   = toLocal(t1);
  }
  refresh();
});

// Window-wide drag & drop
["dragenter","dragover","dragleave","drop"].forEach(evt=>{
  document.addEventListener(evt, e=>{
    if(evt!=="drop"){ e.preventDefault(); }
  }, false);
});
document.addEventListener("dragover", e=>{ e.preventDefault(); document.getElementById("drop").style.background="#0b1220"; });
document.addEventListener("dragleave", e=>{ document.getElementById("drop").style.background=""; });
document.addEventListener("drop", e=>{
  e.preventDefault(); document.getElementById("drop").style.background="";
  const items = e.dataTransfer?.files;
  if(items && items.length){ handleFiles(items); toast("드래그 파일 로드 완료"); }
});

document.getElementById("btnLoadURL").addEventListener("click", async ()=>{
  const u1 = document.getElementById("predsURL").value.trim();
  const u2 = document.getElementById("metricsURL").value.trim();
  document.getElementById("loadMsg").innerText = "불러오는 중...";
  try{
    if(u1){ const t1 = await fetchText(u1); RAW = adaptRows(Papa.parse(t1, {header:true, dynamicTyping:true}).data); ALL = ALL || {}; ALL.rows=RAW; ALL.names=ALL.names||{}; ALL.names.preds=u1; }
    if(u2){ const t2 = await fetchText(u2); MET = JSON.parse(t2); ALL = ALL || {}; ALL.metrics=MET; ALL.names=ALL.names||{}; ALL.names.metrics=u2; }
    document.getElementById("loadMsg").innerText = "완료";
    afterLoad();
  }catch(err){
    document.getElementById("loadMsg").innerText = "실패: "+err.message;
  }
});
</script>
</body>
</html>
