name: Run trade4v v3 backtest

on:
  workflow_dispatch:
    inputs:
      data_path:
        description: "데이터 경로 (예: ETHUSDT_1min_2025H1.csv 또는 .zip)"
        required: true
        type: string
      code_zip:
        description: "코드 ZIP 파일명(리포 루트). 비워두면 trade4v/ 폴더 사용"
        required: false
        default: "trade4v_S1S2_codepack_v3.zip"
        type: string
      train_start:
        description: "학습 시작(UTC)"
        required: true
        default: "2025-01-01 00:00:00"
        type: string
      train_end:
        description: "학습 종료(UTC)"
        required: true
        default: "2025-04-30 23:59:00"
        type: string
      test_start:
        description: "테스트 시작(UTC)"
        required: true
        default: "2025-05-01 00:00:00"
        type: string
      test_end:
        description: "테스트 종료(UTC)"
        required: true
        default: "2025-06-30 23:59:00"
        type: string
      H:
        description: "홀드 분(H)"
        required: true
        default: "15"
        type: string
      fee_bps:
        description: "수수료(bp)"
        required: true
        default: "1.0"
        type: string
      slip_bps:
        description: "슬리피지(bp)"
        required: true
        default: "0.5"
        type: string
      ev_margin_bps:
        description: "EV 마진(bp) — fee+slip 위에 추가"
        required: true
        default: "1.0"
        type: string
      K_day:
        description: "레짐별 K/일 (예: 0:5,1:10,2:20)"
        required: true
        default: "0:5,1:10,2:20"
        type: string
      out_dir:
        description: "출력 폴더"
        required: true
        default: "_out_4u"
        type: string

jobs:
  backtest:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout (pinned)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Setup Python 3.11 (pinned)
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.11'

      - name: Install deps (minimal)
        run: |
          python -m pip install -U pip
          pip install "pandas>=2.0" "numpy>=1.24"

      - name: Prepare data
        shell: bash
        run: |
          set -euo pipefail
          DATA="${{ inputs.data_path }}"
          mkdir -p data
          [[ -e "$DATA" ]] || { echo "::error::data_path '$DATA' not found"; exit 1; }
          if [[ "$DATA" == *.zip ]]; then unzip -o -q "$DATA" -d data; else cp -f "$DATA" data/; fi
          echo "Using CSV:"; ls -1 data/*.csv | head -n1

      - name: Prepare code (prefer committed ./trade4v, otherwise unzip code_zip)
        id: codeprep
        shell: bash
        run: |
          set -euo pipefail
          CODEZIP="${{ inputs.code_zip }}"
          if [[ -d trade4v && -f trade4v/trade4v/run_4u.py ]]; then
            echo "Found committed ./trade4v/"
            echo "SCRIPT=trade4v/trade4v/run_4u.py" >> "$GITHUB_OUTPUT"
          else
            if [[ -n "$CODEZIP" && -f "$CODEZIP" ]]; then
              echo "Unzipping $CODEZIP"
              rm -rf __extracted trade4v || true
              unzip -o -q "$CODEZIP" -d __extracted
              # 평탄화: 최상위에 trade4v/ 가 오도록
              if [[ -d __extracted/trade4v ]]; then mv __extracted/trade4v ./trade4v; else
                # zip 안에 상위폴더/trade4v 형태 지원
                TDIR="$(find __extracted -type d -name trade4v | head -n1 || true)"
                [[ -n "$TDIR" ]] || { echo "::error::trade4v folder not found in zip"; exit 1; }
                mv "$TDIR" ./trade4v
              fi
              echo "SCRIPT=trade4v/trade4v/run_4u.py" >> "$GITHUB_OUTPUT"
            else
              echo "::error::Neither committed ./trade4v nor code_zip exists"; exit 1
            fi
          fi
          [[ -f ${{ steps.codeprep.outputs.SCRIPT }} ]] || { echo "::error::run_4u.py not found"; exit 1; }
          echo "Using ${ { steps.codeprep.outputs.SCRIPT } }" || true

      - name: Run backtest (v3)
        shell: bash
        run: |
          set -euo pipefail
          export PYTHONPATH="$PWD/trade4v"
          OUT="${{ inputs.out_dir }}"
          CSV=$(ls -1 data/*.csv | head -n1)
          mkdir -p "$OUT"
          python "${{ steps.codeprep.outputs.SCRIPT }}" \
            --data "$CSV" \
            --train_start "${{ inputs.train_start }}" \
            --train_end   "${{ inputs.train_end }}" \
            --test_start  "${{ inputs.test_start }}" \
            --test_end    "${{ inputs.test_end }}" \
            --H "${{ inputs.H }}" \
            --fee_bps "${{ inputs.fee_bps }}" \
            --slip_bps "${{ inputs.slip_bps }}" \
            --ev_margin_bps "${{ inputs.ev_margin_bps }}" \
            --K_day "${{ inputs.K_day }}" \
            --out_dir "$OUT"

      - name: Show outputs (preview)
        if: always()
        run: |
          echo "== files =="; find "${{ inputs.out_dir }}" -maxdepth 3 -type f -print | sed 's/^/  /'
          echo "== run.log tail =="; tail -n 50 "${{ inputs.out_dir }}"/run/run.log || true
          echo "== metrics =="; cat "${{ inputs.out_dir }}"/run/metrics_oos.json || true
          echo "== preds head =="; head -n 5 "${{ inputs.out_dir }}"/run/preds_test.csv || true

      - name: Upload artifacts (pinned)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: out_4u_v3
          path: |
            ${{ inputs.out_dir }}/run/preds_test.csv
            ${{ inputs.out_dir }}/run/metrics_oos.json
            ${{ inputs.out_dir }}/run/run.log
          if-no-files-found: error
          retention-days: 14
